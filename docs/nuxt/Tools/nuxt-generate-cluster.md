# Nuxt.js 多线程生成命令
[![npm](https://img.shields.io/npm/dt/nuxt-generate-cluster.svg?style=flat-square)](https://www.npmjs.com/package/nuxt-generate-cluster)
[![npm (scoped with tag)](https://img.shields.io/npm/v/nuxt-generate-cluster/latest.svg?style=flat-square)](https://www.npmjs.com/package/nuxt-generate-cluster)
<a href="https://github.com/nuxt/nuxt.js/"><img src="https://img.shields.io/badge/nuxt.js-v2.0.0-800080.svg?style=flat-square" alt=""/></a>

> 使用多个 Workers 来为Nuxt.js项目生成静态文件

## 使用

安装包
```js
yarn add nuxt-generate-cluster`
OR
npm install nuxt-generate-cluster
```

添加生成脚本到您的 `package.json`
```js
"scripts": {
    "generate": "nuxt-generate -w 4"
}
```

## Nuxt 配置选项

配置生成的选项到 `nuxt.config.js`
```js
  generate: {
    workers: 4,
    workerConcurrency: 500,
    concurrency: 500,
    routes (callback, params) {
      return axios.get('https://api.example.com/routes?since=' + params.lastFinished)
      .then((res) => {
        return res.data
      })
    },
    done ({ duration, errors, workerInfo }) {
      if (errors.length) {
        axios.post('https://api.example.com/routes', { generate_errors: errors })
      }
    }
  }
```

### `workers`
- Default: number of processors

应该配置 workers 数量。因为它可能没有用来启动 workers，然后在系统中使用处理器的数量。

### `workerConcurrency`
- Default: `500`

为了平衡 workers 之间的负荷，他们会被发送成批的线程，否则一个拥有 '简单' 线程的 workers 可能会在其他人之前很久就完成。 workers 还将使用Nuxt的并发选项。

### `routes`

默认的[Nuxt.js routes 方法](https://nuxtjs.org/api/configuration-generate#routes)已经扩展，因此您可以向其传递其他参数，请参阅以下示例配置中的params参数。默认情况下，它将列出3个时间戳：

- `lastStarted`
上次执行nuxt-generate命令时的unix时间戳

- `lastBuilt`
nuxt项目最后由nuxt-generate构建时的unix时间戳

- `lastFinished`
nuxt-generate上次成功完成时的unix时间戳（未被 `ctrl+c` 中断）

> 时间戳在本地 `~/.data-store/nuxt-generate-cluster.json` 存储，详情请参考 [data-store](https://github.com/jonschlinkert/data-store)

### `done`

当所有 workers 完成时，将调用此方法，它会接收三个参数:

- `duration`
命令运行的总时间（以秒为单位）

- `errors`
遇到的所有错误的数组。错误可以有类型，`handled` 或者 `unhandled` 对于后者，错误消息将包含堆栈跟踪

```js
[ { type: 'handled',
    route: '/non-existing-link',
    error: 
     { statusCode: 404,
       message: 'The message from your 404 page' } }
]
```

- `workerInfo`
包含每个 workers 详细信息的对象。传递的数据来自内部用于监视 workers 状态的监视程序对象。

```js
{{ '6707':                            // the process id of the worker
   { start: [ 1929158, 859524606 ],   // process.hrtime the worker was started
     duration: 109567,                // how long the worker was active
     signal: 0,                       // the signal by which the worker was killed (if any)
     code: 0,                         // the exit status of the worker
     routes: 73,                      // the number of routes generated by this worker
     errors: [] },                    // the errors this worker encountered, errors of all workers
                                      // combined is the error argument above
}
```

## 命令行选项

> 请注意，您需要明确指出 `-b` 您想要（重新）构建项目

```
$ ./node_modules/.bin/nuxt-generate -h

  Multi-threaded generate for nuxt using cluster

  Description
    Generate a static web application (server-rendered)
  Usage
    $ nuxt-generate <dir>
  Options
    -b, --build           Whether to (re-)build the nuxt project
    -c, --config-file     Path to Nuxt.js config file (default: nuxt.config.js)
    -h, --help            Displays this message
    -p, --params          Extra parameters which should be passed to routes method
                            (should be a JSON string or queryString)
    -q, --quiet           Decrease verbosity (repeat to decrease more)
    -v, --verbose         Increase verbosity (repeat to increase more)
    -w, --workers [NUM]   How many workers should be started
                            (default: # cpus)
    -wc [NUM],            How many routes should be sent to 
    --worker-concurrency [NUM]    a worker per iteration

```

如果需要控制更多生成的路径，请使用 `-p` 选项将其他参数传递给routes方法。

```
# nuxt.config.js
generate: {
  routes (callback, params) {
    console.log(params)
  }
}

$ nuxt-generate -w 2 -p id=1&id=2
// will print =>
{ id: [ '1', '2' ],
  lastStarted: 1508609323,
  lastBuilt: 0,
  lastFinished: 0 }
```

如果你在bash下使用npm脚本 `--` 将会把参数传递给nuxt-generate而不是npm：

```
$ npm run generate -- -p '{ "id": [1,2,3] }'
// will print =>
{ id: [ 1, 2, 3 ],
  lastStarted: 1508786574,
  lastBuilt: 0,
  lastFinished: 0 }
```

## 记录

您可以使用多个 `-v` 或 `-q` 在命令行上增加或减少详细程度。我们使用consola进行日志记录并将默认日志级别设置为3，除非设置了 DEBUG 为5，如果要在不设置DEBUG的情况下记录调试消息，可以在 `-vv` 命令行上使用

日志级别2、3和4之间的差异是:

- `Level 2` (-q)
只打印主线程消息，比如worker启动/退出。没有子线程的消息。

- `Level 3`
还要打印子线程生成的路由

- `Level 4` (-v)
还打印路由生成所花费的时间以及主线程和子线程之间的消息

## 链接

- [nuxt-community/nuxt-generate-cluster](https://github.com/nuxt-community/nuxt-generate-cluster) - Nuxt.js 多线程生成命令。
